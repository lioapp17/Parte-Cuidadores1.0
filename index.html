<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parte Fin de Semana – Bioparque</title>

  <!-- PWA (opcional, si ya lo estás usando con GitHub Pages) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b0c10">

  <style>
    :root{--bg:#0b0c10;--card:#111319;--muted:#8b94a7;--text:#e9eefc;--line:#222735;--btn:#1f6feb;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    body{margin:0;background:linear-gradient(180deg,#0b0c10,#07080b);color:var(--text);}
    header{padding:18px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,12,16,.9);backdrop-filter:blur(10px);z-index:5}
    h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:12px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:rgba(17,19,25,.95);border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:620px){.row2{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:10px 10px;border-radius:10px;
      border:1px solid var(--line);background:#0d0f15;color:var(--text);
      outline:none
    }
    textarea{min-height:110px;resize:vertical;line-height:1.35}
    .small{min-height:80px}
    .btns{display:flex;flex-wrap:wrap;gap:8px}
    button{
      border:1px solid var(--line);background:#0d0f15;color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:13px
    }
    button.primary{background:var(--btn);border-color:transparent}
    button.danger{background:#b42318;border-color:transparent}
    button:active{transform:translateY(1px)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .sector-head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .sector-title{font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .list{display:grid;gap:8px;margin-top:10px}
    .item{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0d0f15}
    .item-top{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .item-meta{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .toast{position:fixed;right:14px;bottom:14px;background:#121826;border:1px solid var(--line);padding:10px 12px;border-radius:12px;color:var(--text);display:none}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>Parte Fin de Semana / Feriado – Bioparque</h1>
    <div class="sub">Anotaciones rápidas por sectores · guarda offline · exporta texto para IA</div>
  </header>

  <main>
    <div class="grid">
      <!-- Izquierda -->
      <section class="card">
        <div class="sector-head">
          <div>
            <div class="sector-title">Datos del período</div>
            <div class="muted">Cargás una vez y luego anotás sin pensar</div>
          </div>
          <span class="pill" id="autosavePill">Auto-guardado: ON</span>
        </div>

        <div class="row2">
          <div>
            <label>Desde</label>
            <input type="date" id="desde">
          </div>
          <div>
            <label>Hasta</label>
            <input type="date" id="hasta">
          </div>
        </div>

        <div class="row2" style="margin-top:10px">
          <div>
            <label>Tipo</label>
            <select id="tipo">
              <option>Fin de semana</option>
              <option>Feriado</option>
              <option>Feriado largo</option>
            </select>
          </div>
          <div>
            <label>Encargado</label>
            <input id="encargado" placeholder="Nombre y apellido">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label>Condiciones generales del período (clima, afluencia, contexto)</label>
          <textarea id="condiciones" class="small" placeholder="Ej: Clima caluroso, afluencia moderada. Turno con buen funcionamiento general."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <label>Dotación general (nombres / sectores cubiertos)</label>
          <textarea id="dotacion" class="small" placeholder="Ej: Cuidador A (Felinos), Cuidador B (Aves), ..."></textarea>
        </div>
      </section>

      <!-- Derecha -->
      <aside class="card">
        <div class="sector-head">
          <div>
            <div class="sector-title">Exportación</div>
            <div class="muted">Pegás esto en la IA y te arma el informe</div>
          </div>
        </div>
        <div class="btns">
          <button class="primary" id="btnExportTexto">Copiar texto para IA</button>
          <button id="btnExportJSON">Descargar JSON</button>

          <!-- NUEVO: Importar JSON -->
          <button id="btnImportJSON">Importar JSON</button>
          <input id="fileImportJSON" type="file" accept="application/json" style="display:none" />

          <button id="btnNuevoParte">Nuevo parte</button>
          <button class="danger" id="btnBorrarTodo">Borrar todo</button>
        </div>
        <div style="margin-top:10px">
          <label>Vista previa (texto para IA)</label>
          <textarea id="preview" class="mono" readonly></textarea>
          <div class="hint">
            Tip: en el texto, usá “Sáb.” / “Dom.” / “Feriado” al inicio de cada nota si necesitás ubicar en el tiempo.
          </div>
        </div>
      </aside>
    </div>

    <section class="card">
      <div class="sector-head">
        <div>
          <div class="sector-title">Registro operativo por sectores</div>
          <div class="muted">Estilo agenda: escribís natural. Los sectores se pueden editar.</div>
        </div>
        <div class="btns">
          <button id="btnAgregarSector">+ Agregar sector</button>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Sector</label>
          <select id="sectorSelect"></select>
        </div>
        <div>
          <label>Etiqueta rápida (opcional)</label>
          <input id="tag" placeholder="Ej: Sáb. / Dom. / Feriado">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Anotación</label>
        <textarea id="nota" placeholder="Ej: Recorrido inicial. Alimentación realizada sin inconvenientes. Se observa traba de reja con dificultad. Se eleva a mantenimiento."></textarea>
      </div>

      <div class="btns" style="margin-top:10px">
        <button class="primary" id="btnGuardarNota">Guardar anotación</button>
        <button id="btnLimpiarNota">Limpiar</button>
      </div>

      <div class="list" id="listaNotas"></div>
    </section>

    <section class="card">
      <div class="sector-head">
        <div>
          <div class="sector-title">Cierre del período</div>
          <div class="muted">Esto te permite “cerrar mentalmente” el finde</div>
        </div>
      </div>

      <div class="row">
        <label>Síntesis general (3–6 líneas)</label>
        <textarea id="sintesis" class="small" placeholder="Ej: El período se desarrolló con normalidad. Se registran observaciones en sector aves..."></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Derivaciones realizadas (a quién se informó)</label>
        <textarea id="derivaciones" class="small" placeholder="Ej: Veterinaria (…), Biología (…), Mantenimiento (…)"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Pendientes para la semana</label>
        <textarea id="pendientes" class="small" placeholder="Ej: Revisar traba reja sector aves. Seguimiento conducta puma."></textarea>
      </div>
    </section>

    <!-- NUEVO: Recordatorios -->
    <section class="card">
      <div class="sector-head">
        <div>
          <div class="sector-title">Recordatorios</div>
          <div class="muted">Agenda reuniones/encuentros. Notifica si la app está abierta. También podés exportar a Calendario (.ics).</div>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Título</label>
          <input id="remTitulo" placeholder="Ej: Reunión con curatorial">
        </div>
        <div>
          <label>Fecha y hora</label>
          <input id="remFecha" type="datetime-local">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Detalle / lugar (opcional)</label>
        <input id="remDetalle" placeholder="Ej: Oficina / Zoom / Recorrido sector...">
      </div>

      <div class="btns" style="margin-top:10px">
        <button class="primary" id="btnGuardarRem">Guardar recordatorio</button>
        <button id="btnPermisoNotif">Activar notificaciones</button>
      </div>

      <div class="list" id="listaRem"></div>
      <div class="hint">
        Nota: para que el celular te avise sí o sí incluso con la app cerrada, usá el botón “Calendario” (descarga .ics).
      </div>
    </section>

    <div class="toast" id="toast">Copiado ✅</div>
  </main>

<script>
  const STORAGE_KEY = "bioparque_parte_v1";
  const $ = (id) => document.getElementById(id);

  const state = {
    desde: "",
    hasta: "",
    tipo: "Fin de semana",
    encargado: "Leandro N. Delgado",
    condiciones: "",
    dotacion: "",
    sectores: ["1", "2", "3", "4", "Extra"],
    notas: [], // {id, ts, sector, tag, texto}
    cierre: { sintesis:"", derivaciones:"", pendientes:"" },

    // NUEVO
    recordatorios: [] // {id, titulo, detalle, whenISO, done:false}
  };

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function nowISO(){ return new Date().toISOString(); }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderPreview();
  }
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      Object.assign(state, data);
      // compatibilidad hacia atrás
      if(!Array.isArray(state.recordatorios)) state.recordatorios = [];
      if(!state.cierre) state.cierre = {sintesis:"", derivaciones:"", pendientes:""};
    }catch(e){}
  }

  function toast(msg="Listo ✅"){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", 1400);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderSectores(){
    const sel = $("sectorSelect");
    sel.innerHTML = "";
    state.sectores.forEach((s)=>{
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    });
  }

  function renderNotas(){
    const cont = $("listaNotas");
    cont.innerHTML = "";
    const sorted = [...state.notas].sort((a,b)=> (a.ts < b.ts ? 1 : -1));
    sorted.forEach(n=>{
      const div = document.createElement("div");
      div.className = "item";
      const fecha = new Date(n.ts);
      const when = fecha.toLocaleString("es-AR", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });

      div.innerHTML = `
        <div class="item-top">
          <div>
            <div><strong>${escapeHtml(n.sector)}</strong> ${n.tag ? `<span class="pill">${escapeHtml(n.tag)}</span>` : ""}</div>
            <div class="item-meta">${when}</div>
          </div>
          <div class="btns">
            <button data-act="edit" data-id="${n.id}">Editar</button>
            <button class="danger" data-act="del" data-id="${n.id}">Borrar</button>
          </div>
        </div>
        <div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(n.texto)}</div>
      `;
      cont.appendChild(div);
    });

    cont.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        if(act==="del"){
          state.notas = state.notas.filter(x=>x.id!==id);
          save(); renderNotas();
        } else if(act==="edit"){
          const n = state.notas.find(x=>x.id===id);
          if(!n) return;
          $("sectorSelect").value = n.sector;
          $("tag").value = n.tag || "";
          $("nota").value = n.texto;
          // al guardar, reemplaza (simple)
          state.notas = state.notas.filter(x=>x.id!==id);
          save(); renderNotas();
          toast("Listo para editar ✍️");
        }
      });
    });
  }

  function renderForm(){
    $("desde").value = state.desde || "";
    $("hasta").value = state.hasta || "";
    $("tipo").value = state.tipo || "Fin de semana";
    $("encargado").value = state.encargado || "";
    $("condiciones").value = state.condiciones || "";
    $("dotacion").value = state.dotacion || "";
    $("sintesis").value = state.cierre?.sintesis || "";
    $("derivaciones").value = state.cierre?.derivaciones || "";
    $("pendientes").value = state.cierre?.pendientes || "";
  }

  function buildTextForIA(){
    const header = [
      "PARTE DE FIN DE SEMANA / FERIADO – BIOPARQUE (anotaciones)",
      `Período: ${state.desde || "____"} a ${state.hasta || "____"}`,
      `Tipo: ${state.tipo || "____"}`,
      `Encargado: ${state.encargado || "____"}`,
      "",
      "Condiciones generales:",
      state.condiciones?.trim() ? state.condiciones.trim() : "(sin datos)",
      "",
      "Dotación general:",
      state.dotacion?.trim() ? state.dotacion.trim() : "(sin datos)",
      ""
    ].join("\n");

    // agrupar por sector
    const bySector = {};
    state.notas.forEach(n=>{
      if(!bySector[n.sector]) bySector[n.sector] = [];
      bySector[n.sector].push(n);
    });

    const sectorBlocks = state.sectores.map(sec=>{
      const notes = (bySector[sec] || []).sort((a,b)=> a.ts < b.ts ? -1 : 1);
      const lines = notes.map(n=>{
        const tag = n.tag ? `[${n.tag}] ` : "";
        return `- ${tag}${n.texto.replace(/\n/g, " ").trim()}`;
      });
      return [
        `SECTOR: ${sec}`,
        lines.length ? lines.join("\n") : "- (sin novedades registradas)",
        ""
      ].join("\n");
    }).join("\n");

    const cierre = [
      "CIERRE DEL PERÍODO",
      "Síntesis general:",
      state.cierre?.sintesis?.trim() ? state.cierre.sintesis.trim() : "(sin datos)",
      "",
      "Derivaciones realizadas:",
      state.cierre?.derivaciones?.trim() ? state.cierre.derivaciones.trim() : "(sin datos)",
      "",
      "Pendientes para la semana:",
      state.cierre?.pendientes?.trim() ? state.cierre.pendientes.trim() : "(sin datos)"
    ].join("\n");

    const prompt = [
      "",
      "INSTRUCCIÓN PARA IA:",
      "Con el parte anterior, redactá un informe institucional breve de cierre de fin de semana.",
      "Estructura sugerida: (1) resumen general, (2) novedades por sectores, (3) incidencias/derivaciones, (4) pendientes y recomendaciones.",
      "Tono: técnico, claro, sin dramatizar; sin opiniones personales; con foco operativo."
    ].join("\n");

    return [header, sectorBlocks, cierre, prompt].join("\n");
  }

  function renderPreview(){
    $("preview").value = buildTextForIA();
  }

  // ========== Autosave ==========
  function bindAutosave(){
    const ids = ["desde","hasta","tipo","encargado","condiciones","dotacion","sintesis","derivaciones","pendientes"];
    ids.forEach(id=>{
      $(id).addEventListener("input", ()=>{
        if(id==="sintesis") state.cierre.sintesis = $(id).value;
        else if(id==="derivaciones") state.cierre.derivaciones = $(id).value;
        else if(id==="pendientes") state.cierre.pendientes = $(id).value;
        else state[id] = $(id).value;

        save();
      });
      $(id).addEventListener("change", ()=>{ $(id).dispatchEvent(new Event("input")); });
    });
  }

  // ========== Importar JSON ==========
  function isValidImportedState(obj){
    if(!obj || typeof obj !== "object") return false;
    if(!("sectores" in obj) || !Array.isArray(obj.sectores)) return false;
    if(!("notas" in obj) || !Array.isArray(obj.notas)) return false;
    if(!("cierre" in obj) || typeof obj.cierre !== "object") return false;
    return true;
  }

  function importStateFromJSON(obj){
    if(!isValidImportedState(obj)){
      toast("JSON inválido");
      return;
    }
    Object.assign(state, obj);

    // defaults / compat
    if(!Array.isArray(state.recordatorios)) state.recordatorios = [];
    if(!state.cierre) state.cierre = {sintesis:"", derivaciones:"", pendientes:""};

    save();
    renderSectores();
    renderForm();
    renderNotas();
    renderReminders();
    renderPreview();
    toast("Importado ✅");
  }

  // ========== Recordatorios ==========
  function requestNotifPermission(){
    if(!("Notification" in window)){
      toast("Notificaciones no disponibles");
      return;
    }
    if(Notification.permission === "granted"){
      toast("Notificaciones activas ✅");
      return;
    }
    Notification.requestPermission().then(p=>{
      if(p === "granted") toast("Notificaciones activas ✅");
      else toast("Permiso denegado");
    });
  }

  function fireReminder(r){
    if("Notification" in window && Notification.permission === "granted"){
      try{
        new Notification(r.titulo || "Recordatorio", {
          body: r.detalle || "Evento programado",
          silent: false
        });
      }catch(e){
        toast("Recordatorio: " + (r.titulo || "Evento"));
      }
    } else {
      toast("Recordatorio: " + (r.titulo || "Evento"));
    }
  }

  function scheduleTick(){
    setInterval(()=>{
      if(!state.recordatorios?.length) return;
      const now = Date.now();
      let changed = false;

      state.recordatorios.forEach(r=>{
        if(r.done) return;
        const t = Date.parse(r.whenISO);
        if(!isFinite(t)) return;
        if(t <= now){
          r.done = true;
          changed = true;
          fireReminder(r);
        }
      });

      if(changed){
        save();
        renderReminders();
      }
    }, 20000);
  }

  function renderReminders(){
    const cont = $("listaRem");
    cont.innerHTML = "";

    const sorted = [...(state.recordatorios || [])].sort((a,b)=> (a.whenISO > b.whenISO ? 1 : -1));
    sorted.forEach(r=>{
      const div = document.createElement("div");
      div.className = "item";
      const when = new Date(r.whenISO);
      const whenStr = isFinite(when) ? when.toLocaleString("es-AR", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" }) : "Fecha inválida";

      div.innerHTML = `
        <div class="item-top">
          <div>
            <div><strong>${escapeHtml(r.titulo || "Sin título")}</strong> ${r.done ? `<span class="pill">Hecho</span>` : ""}</div>
            <div class="item-meta">${whenStr}${r.detalle ? " · " + escapeHtml(r.detalle) : ""}</div>
          </div>
          <div class="btns">
            <button data-act="ics" data-id="${r.id}">Calendario</button>
            <button data-act="done" data-id="${r.id}">${r.done ? "Reabrir" : "Hecho"}</button>
            <button class="danger" data-act="del" data-id="${r.id}">Borrar</button>
          </div>
        </div>
      `;
      cont.appendChild(div);
    });

    cont.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const r = state.recordatorios.find(x=>x.id===id);
        if(!r) return;

        if(act==="del"){
          state.recordatorios = state.recordatorios.filter(x=>x.id!==id);
          save(); renderReminders();
        } else if(act==="done"){
          r.done = !r.done;
          save(); renderReminders();
        } else if(act==="ics"){
          downloadICS(r);
        }
      });
    });
  }

  function pad(n){ return String(n).padStart(2,"0"); }
  function toICSDate(d){
    return (
      d.getUTCFullYear() +
      pad(d.getUTCMonth()+1) +
      pad(d.getUTCDate()) + "T" +
      pad(d.getUTCHours()) +
      pad(d.getUTCMinutes()) +
      "00Z"
    );
  }

  function downloadICS(r){
    const start = new Date(r.whenISO);
    if(!isFinite(start)){
      toast("Fecha inválida");
      return;
    }
    const end = new Date(start.getTime() + 30*60*1000);

    const uidStr = (r.id || uid()) + "@parte-bioparque";
    const dtstamp = toICSDate(new Date());
    const dtstart = toICSDate(start);
    const dtend = toICSDate(end);

    const title = (r.titulo || "Recordatorio").replace(/\n/g," ");
    const desc = (r.detalle || "").replace(/\n/g," ");

    // Incluye alerta 10 minutos antes (muchos calendarios la respetan)
    const ics = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Parte Bioparque//ES",
      "BEGIN:VEVENT",
      `UID:${uidStr}`,
      `DTSTAMP:${dtstamp}`,
      `DTSTART:${dtstart}`,
      `DTEND:${dtend}`,
      `SUMMARY:${title}`,
      desc ? `DESCRIPTION:${desc}` : "",
      "BEGIN:VALARM",
      "TRIGGER:-PT10M",
      "ACTION:DISPLAY",
      "DESCRIPTION:Recordatorio",
      "END:VALARM",
      "END:VEVENT",
      "END:VCALENDAR"
    ].filter(Boolean).join("\r\n");

    const blob = new Blob([ics], {type:"text/calendar"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `recordatorio_${title.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}.ics`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ========== Eventos UI ==========
  $("btnGuardarNota").addEventListener("click", ()=>{
    const sector = $("sectorSelect").value;
    const tag = $("tag").value.trim();
    const texto = $("nota").value.trim();
    if(!texto){ toast("Escribí una nota"); return; }
    state.notas.push({ id: uid(), ts: nowISO(), sector, tag, texto });
    $("nota").value = "";
    $("tag").value = "";
    save(); renderNotas();
    toast("Guardado ✅");
  });

  $("btnLimpiarNota").addEventListener("click", ()=>{
    $("nota").value = "";
    $("tag").value = "";
  });

  $("btnAgregarSector").addEventListener("click", ()=>{
    const name = prompt("Nombre del nuevo sector:");
    if(!name) return;
    const clean = name.trim();
    if(!clean) return;
    if(state.sectores.includes(clean)){ toast("Ya existe"); return; }
    state.sectores.push(clean);
    save(); renderSectores(); renderPreview();
    toast("Sector agregado ✅");
  });

  $("btnExportTexto").addEventListener("click", async ()=>{
    const text = buildTextForIA();
    try{
      await navigator.clipboard.writeText(text);
      toast("Copiado ✅");
    }catch(e){
      $("preview").focus();
      $("preview").select();
      document.execCommand("copy");
      toast("Copiado ✅");
    }
  });

  $("btnExportJSON").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const safe = (state.desde || "parte");
    a.download = `bioparque_parte_${safe}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  $("btnImportJSON").addEventListener("click", ()=>{
    $("fileImportJSON").click();
  });

  $("fileImportJSON").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      importStateFromJSON(obj);
    }catch(err){
      toast("Error al leer JSON");
    }finally{
      e.target.value = "";
    }
  });

  $("btnNuevoParte").addEventListener("click", ()=>{
    if(!confirm("Crear un nuevo parte (conserva sectores, borra notas y cierre)?")) return;
    state.notas = [];
    state.cierre = {sintesis:"", derivaciones:"", pendientes:""};
    state.condiciones = "";
    state.dotacion = "";
    save(); renderForm(); renderNotas();
    toast("Nuevo parte ✅");
  });

  $("btnBorrarTodo").addEventListener("click", ()=>{
    if(!confirm("BORRAR TODO (incluye sectores y recordatorios). ¿Seguro?")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  $("btnPermisoNotif").addEventListener("click", requestNotifPermission);

  $("btnGuardarRem").addEventListener("click", ()=>{
    const titulo = $("remTitulo").value.trim();
    const whenLocal = $("remFecha").value; // datetime-local
    const detalle = $("remDetalle").value.trim();

    if(!titulo){ toast("Poné un título"); return; }
    if(!whenLocal){ toast("Elegí fecha y hora"); return; }

    const whenISO = new Date(whenLocal).toISOString();

    state.recordatorios.push({
      id: uid(),
      titulo,
      detalle,
      whenISO,
      done: false
    });

    $("remTitulo").value = "";
    $("remFecha").value = "";
    $("remDetalle").value = "";

    save();
    renderReminders();
    toast("Recordatorio guardado ✅");
  });

  // ========== Init ==========
  load();
  renderSectores();
  renderForm();
  bindAutosave();
  renderNotas();
  renderReminders();
  renderPreview();
  scheduleTick();
</script>

<!-- Service Worker (si lo usás como PWA) -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>

</body>
</html>
